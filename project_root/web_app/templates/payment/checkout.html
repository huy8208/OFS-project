{% extends 'base_template.html'%}
{% load static %}
{% block body %}
<!-- Stripe -->
<script src="https://polyfill.io/v3/polyfill.min.js?version=3.52.1&features=fetch"></script>
<script src="https://js.stripe.com/v3/"></script>
<script>var lineItems = [];</script>
<!-- Page Preloder -->
<!-- <div id="preloder">
     <div class="loader"></div>
 </div> -->

<!-- Humberger Begin -->
<div class="humberger__menu__overlay"></div>
<div class="humberger__menu__wrapper">
    <div class="humberger__menu__logo">
        <a href="#"><img src="{% static 'img/OFS-logo.jpg'%}" alt=""></a>
    </div>
    <div class="humberger__menu__cart">
        <ul>
            <li><a href="#"><i class="fa fa-heart"></i> <span>1</span></a></li>
            <li><a href="#"><i class="fa fa-shopping-bag"></i> <span>3</span></a></li>
        </ul>
        <div class="header__cart__price">item: <span>$150.00</span></div>
    </div>
    <div class="humberger__menu__widget">
        <div class="header__top__right__language">
            <img src="{% static 'img/language.jpg'%}" alt="">
            <div>English</div>
            <span class="arrow_carrot-down"></span>
            <ul>
                <li><a href="#">Spanis</a></li>
                <li><a href="#">English</a></li>
            </ul>
        </div>
        <div class="header__top__right__auth">
            <a href="#"><i class="fa fa-user"></i> Login</a>
        </div>
    </div>
    <nav class="humberger__menu__nav mobile-menu">
        <ul>
            <li class="active"><a href="./index.html">Home</a></li>
            <li><a href="./shop-grid.html">Shop</a></li>
            <li><a href="#">Pages</a>
                <ul class="header__menu__dropdown">
                    <li><a href="./shop-details.html">Shop Details</a></li>
                    <li><a href="./shoping-cart.html">Shoping Cart</a></li>
                    <li><a href="./checkout.html">Check Out</a></li>
                    <li><a href="./blog-details.html">Blog Details</a></li>
                </ul>
            </li>
            <li><a href="./blog.html">Blog</a></li>
            <li><a href="./contact.html">Contact</a></li>
        </ul>
    </nav>
    <div id="mobile-menu-wrap"></div>
    <div class="header__top__right__social">
        <a href="#"><i class="fa fa-facebook"></i></a>
        <a href="#"><i class="fa fa-twitter"></i></a>
        <a href="#"><i class="fa fa-linkedin"></i></a>
        <a href="#"><i class="fa fa-pinterest-p"></i></a>
    </div>
    <div class="humberger__menu__contact">
        <ul>
            <li><i class="fa fa-envelope"></i> hello@colorlib.com</li>
            <li>Free Shipping for all Order of $99</li>
        </ul>
    </div>
</div>
<!-- Humberger End -->
<!-- Hero Section Begin -->
<section class="hero hero-normal">
    <div class="container">
        <div class="row">
            <div class="col-lg-3">
                <div class="hero__categories">
                    <div class="hero__categories__all">
                        <i class="fa fa-bars"></i>
                        <span>All departments</span>
                    </div>
                    <ul>
                        <li><a href="#">Fresh Meat</a></li>
                        <li><a href="#">Vegetables</a></li>
                        <li><a href="#">Fruit & Nut Gifts</a></li>
                        <li><a href="#">Fresh Berries</a></li>
                        <li><a href="#">Ocean Foods</a></li>
                        <li><a href="#">Butter & Eggs</a></li>
                        <li><a href="#">Fastfood</a></li>
                        <li><a href="#">Fresh Onion</a></li>
                        <li><a href="#">Papayaya & Crisps</a></li>
                        <li><a href="#">Oatmeal</a></li>
                        <li><a href="#">Fresh Bananas</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-9">
                <div class="hero__search">
                    <div class="hero__search__form">
                        <form action="#">
                            <div class="hero__search__categories">
                                All Categories
                                <span class="arrow_carrot-down"></span>
                            </div>
                            <input type="text" placeholder="What do yo u need?">
                            <button type="submit" class="site-btn">SEARCH</button>
                        </form>
                    </div>
                    <div class="hero__search__phone">
                        <div class="hero__search__phone__icon">
                            <i class="fa fa-phone"></i>
                        </div>
                        <div class="hero__search__phone__text">
                            <h5>+65 11.188.888</h5>
                            <span>support 24/7 time</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Hero Section End -->

<!-- Breadcrumb Section Begin -->
<!-- <section class="breadcrumb-section set-bg" data-setbg="img/breadcrumb.jpg">
     <div class="container">
 @@ -18,7 +134,7 @@ <h2>Checkout</h2>
     </div>
 </section> -->
<!-- Breadcrumb Section End -->

<!-- Checkout Section Begin -->
<section class="checkout spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <h6><span class="icon_tag_alt"></span> Have a coupon? <a href="#">Click here</a> to enter your code
                </h6>
            </div>
        </div>
        <div class="checkout__form">
            <h4>Confirm Your Shipping Details</h4>
            <form name="checkout_form" action="#">
                <div class="row">
                    <div class="col-lg-8 col-md-6">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="checkout__input">
                                    <p>First Name<span>*</span></p>
                                    <input type="text" name="firstname" value="{{customer.get_customer_address.first_name}}"
                                        required>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="checkout__input">
                                    <p>Last Name<span>*</span></p>
                                    <input type="text" name="lastname" value="{{customer.get_customer_address.last_name}}" required>
                                </div>
                            </div>
                        </div>
                        <div class="checkout__input">
                            <p>Country<span>*</span></p>
                            <input type="text" name="country" value="{{customer.get_customer_address.country}}" required>
                        </div>
                        <div class="checkout__input">
                            <p>Address<span>*</span></p>
                            <input type="text" name="address" value="{{customer.get_customer_address.address}}" required>
                        </div>
                        <div class="checkout__input">
                            <p>Town/City<span>*</span></p>
                            <input type="text" name="city" value="{{customer.get_customer_address.city}}" required>
                        </div>
                        <div class="checkout__input">
                            <p>State<span>*</span></p>
                            <input type="text" name="state" value="{{customer.get_customer_address.state}}" required>
                        </div>
                        <div class="checkout__input">
                            <p>Postcode / ZIP<span>*</span></p>
                            <input type="text" name="zipcode" value="{{customer.get_customer_address.zipcode}}" required>
                        </div>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="checkout__input">
                                    <p>Phone<span>*</span></p>
                                    <input type="text" name="phone" value="{{customer.get_customer_address.phone}}" required>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="checkout__input">
                                    <p>Email<span>*</span></p>
                                    <input type="text">
                                </div>
                            </div>
                        </div>
                        <div class="checkout__input__checkbox">
                            <label for="acc">
                                Create an account?
                                <input type="checkbox" id="acc">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <p>Create an account by entering the information below. If you are a returning customer
                            please login at the top of the page</p>
                        <div class="checkout__input">
                            <p>Account Password<span>*</span></p>
                            <input type="text">
                        </div>
                        <div class="checkout__input__checkbox">
                            <label for="diff-acc">
                                Ship to a different address?
                                <input type="checkbox" id="diff-acc">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <div class="checkout__input">
                            <p>Order notes<span>*</span></p>
                            <input type="text" placeholder="Notes about your order, e.g. special notes for delivery.">
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="checkout__order">
                            <h4>Your Order</h4>
                            <div class="checkout__order__products">Products <span>Total</span></div>
                            <ul>
                                {% for ordereditem in items %}
                                <li>{{ordereditem.product.name}}<span>${{ordereditem.get_total|floatformat:2}}</span>
                                </li>
                                <script>
                                    var productPrice = '{{ordereditem.product.price}}';
                                    productPrice = (parseFloat(productPrice) * 100).toFixed(0);
                                    var productIMG = "{{ordereditem.product.imageURL}}";
                                    productIMG = '{{STRIPE_URL|safe}}' + productIMG;
                                    var item = {
                                        'price_data': {
                                            'currency': 'usd',
                                            'unit_amount': productPrice,
                                            'product_data': {
                                                'name': "{{ordereditem.product.name|safe}}",
                                                'images': [productIMG],
                                            },
                                        },
                                        'quantity': "{{ordereditem.quantity}}"
                                    };
                                    lineItems.push(item)
                                </script>
                                {% endfor %}
                            </ul>
                            <div class="checkout__order__subtotal">Subtotal
                                <span>${{order.get_cart_total|floatformat:2}}</span>
                            </div>
                            <div class="checkout__order__total">Total
                                <span>${{order.get_cart_total|floatformat:2}}</span>
                            </div>
                            <div class="checkout__input__checkbox">
                                <label for="acc-or">
                                    Create an account?
                                    <input type="checkbox" id="acc-or">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                            <p>Lorem ipsum dolor sit amet, consectetur adip elit, sed do eiusmod tempor incididunt
                                ut labore et dolore magna aliqua.</p>
                            <div class="checkout__input__checkbox">
                                <label for="payment">
                                    Check Payment
                                    <input type="checkbox" id="payment">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                            <div class="checkout__input__checkbox">
                                <label for="paypal">
                                    Paypal
                                    <input type="checkbox" id="paypal">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                            <button type="button" class="primary-btn btn btn-primary btn-lg"
                                onclick="return submitFormData()">Payment</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>
<!-- Checkout Section End -->
<!-- Stripe -->
<script type="text/javascript">
    function create_stripe_checkout() {
        console.log(JSON.stringify(lineItems));
        var unit_amount = '{{ordereditem.product.price}}';
        // Create an instance of the Stripe object with your publishable API key
        var stripe = Stripe("{{STRIPE_PUBLIC_KEY}}");
        var checkoutButton = document.getElementById("checkout-button");

        fetch("/create-checkout-session/", {
            method: "POST",
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify({ "lineItems": lineItems })
        })
            .then(function (response) {
                return response.json();
            })
            .then(function (session) {
                return stripe.redirectToCheckout({ sessionId: session.id });
            })
            .then(function (result) {
                // If redirectToCheckout fails due to a browser or network
                // error, you should display the localized error message to your
                // customer using error.message.
                if (result.error) {
                    alert(result.error.message);
                }
            })
            .catch(function (error) {
                console.error("Error:", error);
            });
    }

    // Fill out shipping address
    function submitFormData() {
        var form = document.forms["checkout_form"]
        var userFormData = {
            'firstname': null,
            'lastname': null,
            'address': null,
            'city': null,
            'state': null,
            'zipcode': null,
            'country': null,
            'phone': null
        }
        userFormData.firstname = form.firstname.value
        userFormData.lastname = form.lastname.value
        userFormData.address = form.address.value
        userFormData.city = form.city.value
        userFormData.state = form.state.value
        userFormData.zipcode = form.zipcode.value
        userFormData.country = form.country.value
        userFormData.phone = form.phone.value

        if (userFormData.firstname == "" || userFormData.lastname == "" || userFormData.address == ""
            || userFormData.city == "" || userFormData.state == "" || userFormData.zipcode == "" || userFormData.country == "" || userFormData.phone == "") {
            alert("Please fill all required fields.")
            return false;
        }
        else {
            save_user_info(userFormData).then(response => {
                return data = response.json();
                }).then(create_stripe_checkout()).catch(error => {
                console.error("Error, cannot save user info", error);
            })
                // .then(data => {
                // orderResponse = fetch("/create_order/", {
                //     method: "POST",
                //     headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                //     body: JSON.stringify({ "shippingInfo": data, "lineItems": lineItems })
                // })
                // console.log(orderResponse)
                // return orderResponse;})
            // .then(orderResponse => {
            //     console.log(orderResponse.json())
            // })
        }
    }
</script>

{% endblock %}